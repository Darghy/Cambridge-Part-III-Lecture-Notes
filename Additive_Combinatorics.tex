\documentclass{article}
%build with recipe latexmk
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{textcomp}
\usepackage{fancyhdr}
\pagestyle{fancy}

\usepackage{tcolorbox}
\tcbuselibrary{theorems}
\usepackage{babel}
\usepackage{enumerate}
\usepackage{amsmath, amssymb, amsthm}
%\usepackage{a4wide}
\usepackage{float}
\usepackage{tikz-cd}
\usepackage{tikz}
\usepackage{graphicx}
\usepackage{caption}
\usepackage{wrapfig}
\usepackage{setspace}
\setstretch{1.1}
\usepackage{color}
\usepackage{hyperref}
\hypersetup{
    colorlinks=true, %set true if you want colored links
    linktoc=all,     %set to all if you want both sections and subsections linked
    linkcolor=black,  %choose some color if you want links to stand out
}

\theoremstyle{definition}
\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{cor}[theorem]{Corollary}
\newtheorem{prop}[theorem]{Proposition}
\newtheorem{conj}[theorem]{Conjecture}
\newtheorem{example}[theorem]{Example}
\newtheorem{defn}[theorem]{Definition}

\title{Introduction to Additive Combinatorics \\ Part III
    \\ \large
    Lectured by Julia Wolf
}
 
\author{Artur Avameri}
\date{}
 
\setcounter{section}{0}
 
\begin{document}
\maketitle
\tableofcontents
\newpage
 
\section{Fourier--analytic techniques}

\marginpar{19 Jan 2024, Lecture 1}


Let $G = \mathbb{F}_{p}^n$ for $p$ a small fixed prime (usually $p = 2,3,5$) and $n$ is large (often we consider $n \to \infty$).
\vspace{1mm}
 
\textbf{Notation.} Given a finite set $B$ and any function $f : B \to \mathbb{C}$, we write $\mathbb{E}_{x \in B}f(x)$ to mean $\frac{1}{B}\sum_{x \in B} f(x)$. Also write $\omega = e^{2\pi i /p}$ for the $p^{\text{th}}$ root of unity. Note that $\sum_{a \in \mathbb{F}_p}^{} \omega^a = 0$.

\begin{defn}
    Given $f : \mathbb{F}_{p}^n : \mathbb{C}$, we define its \textbf{Fourier transform} $\hat{f} : \mathbb{F}_{p}^n \to \mathbb{C}$ by \[
    \hat{f}(t) = \mathbb{E}_{x \in \mathbb{F}_{p}^n} f(x)\omega^{x \cdot t} ~\forall  t \in \mathbb{F}_{p}^n
    \] 
    where $x \cdot t$ is the standard scalar product.
\end{defn}
It is easy to verify the \textbf{inversion formula}:
\[
f(x) = \sum_{t \in \mathbb{F}_{p}^n}^{} \hat{f}(t) \omega^{-x \cdot t} ~\forall  x \in \mathbb{F}_{p}^n.
\]
Indeed, 
\begin{align*}
    &\sum_{t \in \mathbb{F}_{p}^n}^{} \hat{f}(t) \omega^{-x \cdot t} = \sum_{t \in \mathbb{F}_{p}^n}^{} \left(\mathbb{E}_y f(y) \omega^{y \cdot t} \right)\omega^{-x \cdot t}\\
    =& \mathbb{E}_y f(y) \underbrace{\sum_{t \in \mathbb{F}_{p}^n}^{} \omega^{(y-x)\cdot t}}_{p^n 1_{\{y=x\}}} = f(x).
\end{align*}

\textbf{Remark.} We could use an unnormalized sum in our definition and a normalized sum in the inversion formula, or a minus sign in our definition and a plus sign in the inversion formula -- this doesn't matter as long as we're consistent.

\vspace{1mm}
 
Given a subset $A$ of a finite group $G$, write:
\begin{itemize}
    \item $1_A$ for the \textbf{characteristic function} of $A$, i.e. $1_A(x) = \begin{cases}
            1 & \text{if }x \in A\\
            0 & \text{if } x \not\in A
    \end{cases}$. This is also called the \textbf{indicator function}.
    \item $f_A$ for the \textbf{balanced function} of $A$, i.e. $f_A(x) = 1_A(x) - \alpha$, where $\alpha = \frac{|A|}{|G|}$.
    \item $\mu_A$ for the \textbf{characteristic measure} of $A$, i.e. $\mu_A(x) = \alpha^{-1} 1_A(x)$.
\end{itemize}
Note $\mathbb{E}_{x \in G}f_A(x) = 0$ and $\mathbb{E}_{x \in G}\mu_A(x)=1$. Given $A \subset \mathbb{F}_{p}^n$, we have \[
\hat{1}_A(t) = \mathbb{E}_{x \in \mathbb{F}_{p}^n} 1_A(x)\omega^{x \cdot t}.
\]
At $t=0$, we get $\hat{1}_A(0) = \mathbb{E}_{x \in \mathbb{F}_{p}^n}1_A(x) = \alpha$.
\vspace{1mm}
 
Writing $-A = \{-a \mid a \in A\}$, we have 
\begin{align*}
    &\hat{1}_{-A}(t) = \mathbb{E}_{x \in \mathbb{F}_{p}^n} 1_{-A}(x) \omega^{x\cdot t} = \mathbb{E}_{x \in \mathbb{F}_{p}^n} 1_A(-x)\omega^{x \cdot t} \\
    \stackrel{y=-x}{=}&  \mathbb{E}_{y \in \mathbb{F}_{p}^n} 1_A(y) \omega^{-y \cdot t} = \overline{\mathbb{E}_{y \in \mathbb{F}_{p}^n}1_A(y)\omega^{y \cdot t}} = \overline{\hat{1}_A(t)}.
\end{align*}
\begin{example}\label{ex1.2}
    Let $V \le \mathbb{F}_{p}^n$. Then 
    \begin{align*}
        &\hat{1}_V(t) = \mathbb{E}_{x \in \mathbb{F}_{p}^n}1_V(x)\omega^{x\cdot t} = \frac{|V|}{p^n} 1_{\{x\cdot t = 0 ~\forall x \in V\}} = \frac{|V|}{p^n}1_{V^{\perp}}(t),
    \end{align*}
    so $\hat{\mu}_V(t) = 1_{V^{\perp}}(t)$.
    (Here we use the fact that if $t \not\in \{x \cdot t = 0 ~\forall x \in V\}$, then $x\cdot t$ runs over the values uniformly and the sum is zero - details left as exercise).
\end{example}
\begin{example}\label{ex1.3}
    Let $R \subset \mathbb{F}_{p}^n$ be such that each $x \in \mathbb{F}_{p}^n$ lies in $R$ independently with probability $\frac{1}{2}$. Then with high probability (i.e. $\mathbb{P} \to 1$ as $n \to \infty$),
    \[
    \sup_{t \neq 0} |\hat{1}_R(t)| = O\left(\sqrt{\frac{\log (p^n)}{p^n}}\right).
    \]
    Proving this is on Ex. Sheet 1. This is proved using a Chernoff--type bound: given complex--valued independent random variables $X_1,\ldots,X_n$ with mean 0, $~\forall \theta \ge 0$, 
    \[
    \mathbb{P}\left(\left|\sum_{i=1}^{n} X_i\right| \ge \theta \sqrt{\sum_{i=1}^{n} ||X_i||^2_{L^\infty(\mathbb{P})}}\right) \le 4\exp \left(-\theta^2/4\right).
    \]
\end{example}
\begin{example}
    Let $Q = \{x \in \mathbb{F}_{p}^n \mid x \cdot x = 0\}$. Then $|Q| = \left(\frac{1}{p} + O(p^{-n}) \right)p^n$ and $\sup_{t \neq 0}|\hat{1}_Q(t)| = O(p^{-n/2})$. This is again on Ex. Sheet 1.
\end{example}
\textbf{Notation.} Given $f,g : \mathbb{F}_{p}^n \to \mathbb{C}$, write \[
\langle f,g \rangle = \mathbb{E}_{x \in \mathbb{F}_{p}^n}f(x)\overline{g(x)}
\]
and \[
\langle \hat{f},\hat{g}\rangle = \sum_{t \in \mathbb{F}_{p}^n}^{} \hat{f}(t)\overline{\hat{g}(t)}.
\]
Consequently, $||f||_2^2 = \mathbb{E}_x |f(x)|^2$ and $||\hat{f}||_2^2 = \sum_{t}^{} |\hat{f}(t)|^2$.

\begin{lemma}\label{lemma1.5}
    The following hold for all $f, g : \mathbb{F}_{p}^n \to \mathbb{C}$:
    \begin{enumerate}[(i)]
        \item $\langle f,g \rangle = \langle \hat{f}, \hat{g} \rangle$ (Plancherel's identity).
        \item $||f||_2 = ||\hat{f}||_2$ (Parseval's identity).
    \end{enumerate}
\end{lemma}
\begin{proof}
    (ii) follows from (i). For (i), compute
    \begin{align*}
        \langle \hat{f},\hat{g} \rangle &= \sum_{t \in \mathbb{F}_{p}^n}^{} \hat{f}(t)\overline{\hat{g}(t)} = \sum_{t \in \mathbb{F}_{p}^n}^{} \frac{1}{p^{2n}}\sum_{x \in \mathbb{F}_{p}^n}^{} f(x) \omega^{x \cdot t} \sum_{y \in \mathbb{F}_{p}^n}^{} \overline{g(y) \omega^{y\cdot t}}  \\
        &= \frac{1}{p^{2n}}\sum_{x,y \in \mathbb{F}_{p}^n}^{}  f(x)\overline{g(y)}\sum_{t \in \mathbb{F}_{p}^n}^{} \omega^{(x-y)t} = \frac{1}{p^{2n}}\sum_{x \in \mathbb{F}_{p}^n}^{} p^n f(x)\overline{g(x)} = \langle f,g \rangle.
    \end{align*}
    
\end{proof}
\begin{defn}\label{defn1.6}
    Let $\rho > 0$ and $f : \mathbb{F}_{p}^n \to \mathbb{C}$. Define the \textbf{$\rho$--large spectrum} of $f$ to be
    \[
    \text{Spec}_{\rho}(f) = \{t \in \mathbb{F}_{p}^n \mid |\hat{f}(t)| \ge \rho ||f||_1\}.
    \]
\end{defn}
\begin{example}
    By Example \ref{ex1.2}, if $f = 1_V$ with $V \le \mathbb{F}_{p}^n$, then $\forall \rho >0$, $\text{Spec}_{\rho}(f) = V^\perp$. \footnote{Here we have $0<\rho \le 1$, since it is clear by triangle inequality that $||f||_1 \ge |\hat{f}(t)|$.} 
\end{example}
\begin{lemma}\label{lemma1.8}
    For all $\rho > 0$, $|\text{Spec}_{\rho}(f)| \le \rho^{-2}\frac{||f||_2^2}{||f||_1^2}$.
\end{lemma}
\begin{proof}
    By Parseval,
    \begin{align*}
        ||f||_2^2 = ||\hat{f}||_2^2\ge \sum_{t \in \text{Spec}_{\rho}(f)}^{} |\hat{f}(t)^2| \ge |\text{Spec}_{\rho}(f)|(\rho ||f||_1)^2.
    \end{align*}
\end{proof}

\marginpar{22 Jan 2024, Lecture 2}

\begin{defn}\label{defn1.9}
    Given $f, g : \mathbb{F}_p^n \to \mathbb{C}$, define their \textbf{convolution} $f * g :\mathbb{F}_p^n \to \mathbb{C}$ by $$f*g(x) = \mathbb{E}_{y \in \mathbb{F}_p^n}f(y)g(x-y) ~\forall x \in \mathbb{F}_p^n.$$
\end{defn}
\begin{example}\label{ex1.10}
    Given $A, B \subset \mathbb{F}_p^n$, 
    \begin{align*}
        1_A * 1_B(x) &= \mathbb{E}_{y \in \mathbb{F}_p^n}1_A(y)1_B(x-y) = \frac{1}{p^n}|A \cap (x-B)| \\
        &= \frac{1}{p^n} \# \text{ways }x \text{ can be written as }x=a+b \text{ with }a \in A, b \in B.
    \end{align*}
    In particular, the support of $1_A * 1_B$ is the \textbf{sum set} \[
    A+B = \{a+b \mid a \in A, b \in B\}
    \]
    of $A$ and $B$.
\end{example}
\begin{lemma}\label{lemma1.11}
    Given $f, g : \mathbb{F}_p^n \to \mathbb{C}$, $$\widehat{f * g}(t) = \hat{f}(t)\hat{g}(t) ~\forall t \in \mathbb{F}_p^n.$$
\end{lemma}
\begin{proof}
    Set $u = x-y$ to get
    \begin{align*}
        \widehat{f * g}(t) &= \mathbb{E}_{x \in \mathbb{F}_p^n}\left(\mathbb{E}_{y \in \mathbb{F}_p^n}f(y)g(x-y)\right)\omega^{x \cdot t} \\
        &= \mathbb{E}_y f(y) \mathbb{E}_u g(u) \omega^{(u+y)\cdot t} \\
        &= \hat{f}(t)\hat{g}(t).
    \end{align*}
\end{proof}
\begin{example}
    $||\hat{f}||_4^4 = \mathbb{E}_{x+y=z+w}f(x)f(y)\overline{f(z)f(w)}$. This is on Ex. Sheet 1.
\end{example}
\begin{lemma}[Bogolyubov's Lemma]
    Given $A \subset \mathbb{F}_p^n$ of density $\alpha>0$, there exists a subspace $V\le \mathbb{F}_p^n$ of codimension at most $2\alpha^{-2}$ s.t. $A+A-A-A \supset V$. 
\end{lemma}
\begin{proof}
    Observe that 
    \begin{align*}
        A+A-A-A = \text{supp}(\underbrace{1_A * 1_A * 1_{-A} * 1_{-A}}_{:= g}).
    \end{align*}
    Hence we wish to find $V \le \mathbb{F}_p^n$ such that $g(x) > 0 ~\forall x \in V$. Let $K = \text{Spec}_{\rho}(1_A)$ with $\rho$ to be determined later and let $V = \langle K \rangle^{\perp}$. By Lemma \ref{lemma1.8}\footnote{Here $f = 1_A$ and $\alpha = \frac{||f||_1^2}{||f||_2^2} = \frac{\left(\frac{1}{p^n}\sum_{}^{} |f|\right)^2}{\left(\frac{1}{p^n}\sum_{}^{} |f|^2\right)} = \frac{|A|}{p^n} = \alpha$.}, $|K|\le \rho^{-2}\alpha^{-1}$ and hence $\text{codim}(V)\le |K| \le \rho^{-2}\alpha^{-1}$. By the inversion formula, 
    \begin{align*}
        g(x) &= \sum_{t \in \mathbb{F}_p^n}^{} (\widehat{1_A * 1_A * 1_{-A} * 1_{-A}})(t)\omega^{-x\cdot t} \\
        &= \sum_{t \in \mathbb{F}_p^n}^{} |\hat{1}_A(t)|^4 \omega^{-x\cdot t} \\
        &= \alpha^4 + \underbrace{\sum_{t \in K \setminus \{0\}}^{} |\hat{1}_A(t)|^4 \omega^{-x \cdot t}}_{(1)} + \underbrace{\sum_{t \not\in K}^{} |\hat{1}_A(t)|^4 \omega^{-x \cdot t}}_{(2)}.
    \end{align*}
    For $(1)$, we see it is $\ge 0$ since $x \cdot t = 0 ~\forall t \in K, x \in V$. (Note we could give better lower bounds but we don't need them).
    \vspace{1mm}
     
    For $(2)$, we have 
    \begin{align*}
        |(2)| &\le \sum_{t \not\in K}^{} |\hat{1}_A(t)|^4 \le \sup_{t \not\in K} |\hat{1}_A(t)|^2 \sum_{t \not\in K}^{} |\hat{1}_A(t)|^2 \le \sup_{t \not\in K} |\hat{1}_A(t)|^2 \sum_{t}^{} |\hat{1}_A(t)|^2 \\
        &\le (\rho \alpha)^2 ||1_A||_2^2 = \rho^2 \alpha^3.
    \end{align*}
    Now pick $\rho$ such that $\rho^2 \alpha^3 \le \frac{\alpha^4}{2}$, e.g. $\rho = \sqrt{\frac{\alpha}{2}}$, so $g(x) \ge \frac{\alpha^4}{2}>0 ~\forall x \in V$.
\end{proof}
\begin{example}
    The set $A = \{x \in \mathbb{F}_2^n \mid |x|\ge \frac{n}{2}+\frac{\sqrt{n}}{2}\}$ has density at least $\frac{1}{4}$, and there is no coset $C$ of any subspace of codimension at most $\sqrt{n}$ such that $C \subset A + A$. This is on Ex. Sheet 1.
\end{example}
\begin{lemma}\label{lemma1.15}
    Let $A \subset \mathbb{F}_p^n$ of density $\alpha$ be such that $\exists t \neq 0$ in $\text{Spec}_{\rho}(1_A)$. Then $\exists V \le \mathbb{F}_p^n$ of codimension 1 and $\exists x \in \mathbb{F}_p^n$ such that \[
    |A \cap (x+V)| \ge \alpha \left(1+\frac{\rho}{2}\right)|V|.
    \]
\end{lemma}
\begin{proof}
    Let $t\neq 0$ be such that $|\hat{1}_A(t)|\ge \rho \alpha$ and let $V = \langle t \rangle^{\perp}$. Write $v_j + V$ for $j \in [p] := \{1,2,\ldots,p\}$ for the cosets of $V$ such that $v_j + V = \{x \in \mathbb{F}_p^n \mid x \cdot t = j\}$. Then 
    \begin{align*}
        \rho \alpha \le \hat{1}_A(t) &= \hat{f}_A(t) \\
        &= \mathbb{E}_{x \in \mathbb{F}_p^n}(1_A(x)-\alpha)\omega^{x \cdot t} \\
        &= \mathbb{E}_{j \in [p]}\underbrace{\mathbb{E}_{x \in v_j+V}(1_A(x)-\alpha)}_{:= a_j = \frac{|A \cap (v_j +V)|}{|V|}-\alpha}\omega^j.
    \end{align*}
    By the triangle inequality, $\mathbb{E}_{j \in [p]} |a_j|\ge \rho \alpha$. Since $\mathbb{E}_{j \in [p]}a_j = \frac{|A|}{p^{n-1}}- p \alpha = 0$, $\mathbb{E}_{j \in [p]}(a_j + |a_j|) \ge \rho \alpha$, so $\exists j \in [p]$ such that $a_j + |a_j| \ge \rho \alpha \implies a_j \ge \frac{\rho \alpha}{2}$.
\end{proof}

\marginpar{24 Jan 2024, Lecture 3}

\begin{lemma}\label{lemma1.16}
    Let $p\ge 3$ and $A \subset \mathbb{F}_p^n$ of density $\alpha > 0$ be such that $$\sup_{t \neq 0} |\hat{1}_A(t)| = o(1).$$ Then $A$ contains $(\alpha^3+o(1))(p^n)^2$ 3--term arithmetic progressions (3--APs).
\end{lemma}
In other words, a set with small Fourier coefficients has the same number of 3--APs as a truly random set of the same density.
\vspace{1mm}
 
\textbf{Notation.} Given $f,g,h : \mathbb{F}_p^n \to \mathbb{C}$, $T_3(f,g,h) = \mathbb{E}_{x,d} f(x)g(x+d)h(x+2d)$. 

\vspace{1mm}
 
Given $A \subset \mathbb{F}_p^n$, write $2 \cdot A = \{2a \mid a \in A\}$. This is different from $2A = A + A =\{a + a' \mid a,a' \in A\}$.

\begin{proof}
    The number of 3--APs in $A$ is $(p^n)^2$ times $T_3(1_A,1_A,1_A)$, where
    \begin{align*}
        T_3(1_A,1_A,1_A) &= \mathbb{E}_{x,d}1_A(x)1_A(x+d)1_A(x+2d) \\
        &= \mathbb{E}_{x,y}1_A(x)1_A(y)1_A(2y-x) &y=x+d\\
        &= \mathbb{E}_{y}1_A(y) (1_A * 1_A)(2y) \\
        &= \langle 1_{2\cdot A}, 1_A * 1_A \rangle &z=2y\\
        &= \langle \widehat{1_{2\cdot A}}, \widehat{1_A * 1_A}\rangle. &\text{by Plancherel}.
    \end{align*}
    Continue the last manipulation to get 
    \begin{align*}
        &= \langle \widehat{1_{2\cdot A}}, \hat{1}_A^2 \rangle \\
        &= \alpha^3 + \sum_{t \neq 0}^{} \widehat{1_A}(t)^2 \overline{\widehat{1_{2\cdot A}}(t)}.
    \end{align*}
    The last sum in absolute value is at most 
    \begin{align*}
        &\le \sup_{t \neq 0}|\widehat{1_A}(t)|\sum_{t\neq0}^{} |\widehat{1_A}(t)\overline{\widehat{1_{2\cdot A}}(t)}| \\
        &\le \sup_{t\neq 0}|\widehat{1_A}(t)| \left(\sum_{t}^{} |\widehat{1_A}(t)|^2\right)^{1/2}\left(\sum_{t}^{} |\widehat{1_{2\cdot A}}(t)|^2\right)^{1/2}\\
        &\le \sup_{t \neq 0}|\widehat{1_A}(t)|\cdot \alpha^{1/2} \cdot \alpha^{1/2} \\
        &\le \sup_{t \neq 0}|\widehat{1_A}(t)|
    \end{align*}
    by C--S and Parseval.
\end{proof}
Using the above two results, we prove:
\begin{theorem}[Meshulam's Theorem]\label{theorem1.17}
    Let $p\ge 3$ and let $A \subset \mathbb{F}_p^n$ be a set containing no non--trivial 3--APs. Then $|A| = O\left(\frac{p^n}{n \log p}\right)$. 
\end{theorem}
\begin{proof}
    By assumption, $T_3(1_A,1_A,1_A) = \frac{\alpha}{p^n}$, but as in Lemma \ref{lemma1.16}, \[
    T_3(1_A,1_A,1_A) = \alpha^3 + \sum_{t\neq 0}^{} \hat{1}_A(t)^2 \overline{\hat{1}_{2\cdot A}(t)},
    \]
    so $\left|\frac{\alpha}{p^n}-\alpha^3 \right| \le  \sup_{t\neq 0} |\hat{1}_A(t)| \cdot \alpha$, which gives $\sup_{t\neq 0}|\hat{1}_A(t)| \ge \left|\frac{1}{p^n}-\alpha^2\right| \ge \frac{\alpha^2}{2}$ provided $p^n \ge 2\alpha^{-2}$.
    By Lemma \ref{lemma1.15} with $\rho = \frac{\alpha}{2}$, $\exists V \le \mathbb{F}_p^n$ of codimension 1 and $x \in \mathbb{F}_p^n$ such that $|A \cap (x+V)| \ge \left(\alpha +\frac{\alpha^2}{4}\right)|V|$.
    \vspace{1mm}
     
    We iterate this observation. Let $A_0 = A, V_0 = \mathbb{F}_p^n$, $\alpha_0 = \alpha = \frac{|A_0|}{|V_0|}$. At step $i$ of this iteration, we are given a set $A_{i-1} \subset V_{i-1}$ of density $\alpha_{i-1}$ with no nontrivial 3--APs. Provided that $p^{\text{dim}(V_{i-1})}\ge 2\alpha_{i-1}^{-2}$, $\exists V_i \le V_{i-1}$ of codimension 1 and $x_i \in V_{i-1}$ such that $|A_{i-1} \cap (x_i + V_i)|\ge \left(\alpha_{i-1} + \frac{\alpha_{i-1}^2}{4}\right)|V_{i}|$. Set $A_i = A_{i-1} - x$. Note $\alpha_i \ge \alpha_{i-1}+\frac{\alpha_{i-1}^2}{4}$ and $A_i$ is free of nontrivial 3--APs. Through this iteration, the density of $A$ increases from $\alpha$ to $2\alpha$ in at most $\frac{\alpha}{\alpha^2/4} = 4\alpha^{-1}$ steps, from $2\alpha$ to $4\alpha$ in at most $\frac{2\alpha}{(2\alpha)^2/4} = 2\alpha^{-1}$ steps, etc, which reaches 1 in at most 
    \[
        (4\alpha^{-1} + 2\alpha^{-1} + \alpha^{-1} + \ldots) = 8\alpha^{-1}
    \]
    steps. The argument must therefore end with $\text{dim}(V_i)\ge n - 8\alpha^{-1}$, at which point we must have had $p^{\text{dim}(V_i)}\le 2\alpha_i^{-2}\le 2\alpha^{-2}$ (or else we could have continued). But we may assume that $\alpha \ge \sqrt{2}p^{-n/4}$ (else we're done), whence $p^{n - 8 \alpha ^{-1}} \le p^{n/2}$, i.e. $\frac{n}{2} \le 8\alpha ^{-1}$, so $\alpha \le \frac{16}{n}$, finishing the proof (in fact, we can now take $C = 16\log p$ as an explicit constant in the big O notation). 
\end{proof}

\marginpar{26 Jan 2024, Lecture 4}

So for $A \subset \mathbb{F}_3^n$ containing no nontrivial 3--APs, we have $|A| = O\left(\frac{3^n}{n}\right)$. The largest known subset of $\mathbb{F}_3^n$ containing no notrivial 3--APs has size $\ge (2.218)^n$. (Proving $2^n$ is trivial: take all combinations of zeroes and ones with no twos).

\vspace{1mm}
 
From now on, let $G$ be a finite abelian group. $G$ comes equipped with a set of \textbf{characters}, i.e. group homomorphisms $\gamma : G \to \mathbb{C}^\times$, which themselves form a group, denoted by $\hat{G}$, often referred to as the \textbf{dual} of $G$. It turns out that if $G$ is finite and abelian, then $\hat{G} \cong G$. For instance:
\begin{itemize}
    \item If $G = \mathbb{F}_p^n$, then $\hat{G} = \{\gamma_t : x \mapsto \omega^{x \cdot t} \mid t \in G\}$.
    \item If $G = \mathbb{Z}_p := \mathbb{Z}/p\mathbb{Z}$, then $\hat{G} = \{\gamma_t : x \mapsto \omega^{xt} \mid t \in G\}$.
\end{itemize}
\begin{defn}
    Given $f : G \to \mathbb{C}$, define its \textbf{Fourier transform} $\hat{f}: \hat{G} \to \mathbb{C}$ by \[
    \hat{f}(\gamma) = \mathbb{E}_{x \in G}f(x)\gamma(x) ~\forall \gamma \in \hat{G}.
    \]
\end{defn}
It is easy to verify that we have an inversion formula, given by \[
f(x) = \sum_{\gamma \in \hat{G}}^{} \hat{f}(\gamma)\overline{\gamma(x)}.
\]
We can also check that Definition \ref{defn1.6} and \ref{defn1.9}, Examples \ref{ex1.3} and \ref{ex1.10} and Lemmas \ref{lemma1.5}, \ref{lemma1.8} and \ref{lemma1.11} go through in this general context.

\begin{example}
    Let $p$ be a prime, let $L\le p-1$ be even and consider $J = \left[-\frac{L}{2},\frac{L}{2}\right] \subset \mathbb{Z}_p$. Then $\forall t \neq 0$, \[
    |\hat{1}_J(t)| \le \min \left\{\frac{L+1}{p}, \frac{1}{2|t|}\right\}.
    \]
    This is on Ex. Sheet 1. 
\end{example}
\begin{theorem}[Roth's Theorem]\label{theorem1.20}
    Let $A \subset [N] := \{1,2,\ldots,N\}$ be a set containing no non--trivial 3--APs. Then $|A| = O\left(\frac{N}{\log \log N}\right)$.
\end{theorem}
\begin{lemma}
    Let $A \subset [N]$ be of density $\alpha > 0$ satisfying $N > 50\alpha^{-2}$ containing no nontrivial 3--APs. Let $p$ be a prime in $\left[\frac{N}{3},\frac{2N}{3}\right]$ and write $A' = A \cap [p] \subset \mathbb{Z}_p$. Then either 
    \begin{enumerate}[(i)]
        \item $\sup_{t \neq 0} |\hat{1}_{A'}(t)| \ge \frac{\alpha^2}{10}$ (where the Fourier coefficient is computed in $\mathbb{Z}_p$); or
        \item $\exists$ interval $J \subset [N]$ of length $\ge \frac{N}{3}$ such that $|A \cap J| \ge \alpha\left(1+\frac{\alpha}{400}\right)|J|$.
    \end{enumerate}
\end{lemma}
\begin{proof}
    We may assume that $|A'| = |A \cap [p]| \ge \alpha \left(1-\frac{\alpha}{200}\right)p$, since otherwise $|A \cap [p+1, N]| \ge \alpha N - \alpha\left(1-\frac{\alpha}{200}\right)p = \alpha(N-p) + \frac{\alpha^2p}{200} \ge \alpha \left(1 + \frac{\alpha}{400}\right) (N-p)$, so case (ii) holds with $J = [p+1,N]$.
    \vspace{1mm}
     
    Let $A'' = A' \cap \left[\frac{p}{3},\frac{2p}{3}\right]$. Note that all 3--APs of the form $(x,x+d,x+2d) \in A' \times A'' \times A''$ are in fact proper APs  in $[N]$ (and not only in $\mathbb{Z}_p$, since there's no ''wrapping around'', since $x+d, x+2d \in \left[ \frac{p}{3}, \frac{2p}{3}\right]$). 
    \vspace{1mm}
     
    If $\left|A' \cap \left[p/3\right]\right|$ or $\left|A' \cap \left[2p/3, p \right]\right|$ are at least $\frac{2|A'|}{5}$, then we are again in case (ii) (details left as exercise). Hence we may assume that $|A''|\ge \frac{|A'|}{5}$. Now as in Lemma \ref{lemma1.16} and Theorem \ref{theorem1.17} with $\alpha' = |A'|/p, \alpha'' = |A''|/p$, \[
    \frac{\alpha''}{p} = \frac{|A''|}{p^2} = T_3(1_{A'},1_{A''},1_{A''}) = \alpha' \cdot \alpha''^2 + \sum_{t \neq 0}^{} \hat{1}_{A'}(t)\hat{1}_{A''}(t)\overline{\hat{1}_{2\cdot A''}(t)},
    \]
    so as before, 
    \begin{align*}
        &\left|\frac{\alpha''}{p}- \alpha' \alpha''^2 \right| \le \frac{\alpha' \cdot \alpha''^2}{2} \le \sup_{t \neq 0}|\hat{1}_{A'}(t)|\cdot \alpha'' \\
        \implies & \sup|\hat{1}_{A'}(t)|\ge \frac{\alpha' \cdot \alpha''}{2} \ge \frac{(\alpha')^2}{10}
    \end{align*}
    provided that $\frac{\alpha''}{p}\le \frac{\alpha'(\alpha'')^2}{2}$ which holds since (using $p\ge \frac{N}{3}$ and $N > 50\alpha^{-2}$)
    \begin{align*}
        \alpha' \alpha'' p \ge \alpha' \alpha'' \frac{N}{3} > \frac{\alpha'}{\alpha}\frac{\alpha''}{\alpha}\cdot  50 \ge \left(\frac{\alpha'}{\alpha}\right)^2\cdot  10 = \left(1-\frac{\alpha}{200}\right)^2 \cdot 10 \ge \frac{1}{2},
    \end{align*}
    where the last step holds for $\alpha=1$ and hence for any $\alpha\le 1$.
\end{proof}
\marginpar{29 Nov 2024, Lecture 5}

We first now convert the large Fourier coefficient into a density increment.
\begin{lemma}\label{lemma1.22}
    Let $m \in \mathbb{N}$ and let $\phi: [m] \to \mathbb{Z}_p$  by $x \mapsto xt$ for some nonzero $t$. Given $\epsilon>0$, there exists a partition of $[m]$ into progressions $P_i$ of length $\in \left[\epsilon \sqrt{m}/2, \epsilon \sqrt{m}\right]$ such that $\text{diam}(\phi(P_i)) = \max_{x,y \in P_i} \left|\phi(x)-\phi(y)\right|\le \epsilon p ~\forall i$. 
\end{lemma}
\begin{proof}
    Set $u = \left\lfloor \sqrt{m} \right\rfloor$ and consider $0,t,2t,\ldots,ut$. By pigeonhole, we can find $0\le v<w\le u$ such that $\left|wt - vt \right| \le \frac{p}{u}$. Divide $[m]$ into residue classes mod $s$, where $s = w-v$ (so $\left|st \right|\le \frac{p}{u}$). Each of these has size at least $\frac{m}{s}\ge \frac{m}{u}$. But each residue class can be divided into progressions of the form $a, a+s, a+2s, a+ds$ with $\frac{\epsilon u }{2} < d \le \epsilon u$. The diameter of the image of each progression under $\phi$ is $\left|dst \right| \le \epsilon p$. 
\end{proof}
\begin{lemma}
    Let $A \subset [N]$ be of density $\alpha>0$. Let $p$ be a prime in $\left[\frac{N}{3}, \frac{2N}{3}\right]$ and write $A' = A \cap [p]$ as a subset of $\mathbb{Z}_p$. Suppose $\exists t\neq 0$ such that $\left|\widehat{1_A'}(t)\right|\ge \frac{\alpha^2}{10}$. Then there exists a progression $P$ of length at least $\frac{\alpha^2\sqrt{N}}{500}$ such that $\left|A \cap P\right| \ge \alpha \left(1+\frac{\alpha}{80}\right)\left|P\right|$.
\end{lemma}
\begin{proof}
    Let $\epsilon = \frac{\alpha^2}{40\pi}$ and use Lemma \ref{lemma1.22} to partition $[p]$ into progressions $P_i$ of length at least $\frac{\epsilon\sqrt{p}}{2} \ge \frac{\alpha^2}{40\pi}\sqrt{\frac{N}{3}}\cdot \frac{1}{2} \ge \alpha^2\sqrt{N}\cdot \frac{1}{500}$ and $\text{diam}(\phi(P_i))\le \epsilon p$. Fix one $x_i$ from each $P_i$. Now work with the balanced function: since $t\neq 0$, the Fourier coefficient at $t$ is the same for the indicator function and the balanced function.
    \begin{align*}
        \frac{\alpha^2}{10} &\le \left|\widehat{f_{A'}}(t) \right| = \frac{1}{p}\left|\sum_{x \in \mathbb{Z}_p}^{} f_{A'}(x)\omega^{xt}\right| = \frac{1}{p}\left|\sum_{i}^{} \sum_{x \in P_i}^{} f_{A'}(x)\omega^{xt} \right| \\
        &=\frac{1}{p}\left|\sum_{i}^{} \sum_{x \in P_i}^{} f_{A'}(x)\omega^{x_it} + \sum_{i}^{} \sum_{x \in P_i}^{} f_{A'}(x)\left(\omega^{xt}-\omega^{x_it}\right) \right| \\
        &\le \frac{1}{p}\sum_{i}^{} \left|\sum_{x \in P_i}^{} f_{A'}(x) \right| + \frac{1}{p}\sum_{i}^{} \sum_{x \in P_i}^{} \left|f_{A'}(x) \right|2\pi \epsilon \\
        &\le \frac{1}{p}\sum_{i}^{} \left|\sum_{x \in P_i}^{} f_{A'}(x) \right| + \frac{\alpha^2}{20}
    \end{align*}
    since $\left|t(x_i-x) \right|\le \epsilon p ~\forall x \in P_i$. Hence $$\frac{1}{p}\sum_{i}^{} \left|\sum_{x \in P_i}^{} f_{A'}(x) \right| \ge \frac{\alpha^2}{20}.$$
    Since $f_{A'}$ has mean zero, 
    \begin{align*}
        \sum_{i}^{} \left(\left|\sum_{x \in P_i}^{} f_{A'}(x) \right| + \sum_{x \in P_i}^{} f_{A'}(x) \right) \ge \frac{\alpha^2 p}{20},
    \end{align*}
    so $\exists i$ such that $\left|\sum_{x \in P_i}^{} f_{A'}(x) \right| + \sum_{x \in P_i}^{} f_{A'}(x) \ge \frac{a^2\left|P_i \right|}{40}$ and so 
    \begin{align*}
        \sum_{x \in P_i}^{} f_{A'}(x) \ge \frac{\alpha^2 \left|P_i \right|}{80}.
    \end{align*}
\end{proof}
This is about as technical as we get in this course.
\begin{proof}[Proof of Roth's Theorem, theorem \ref{theorem1.20}]
    This is on Ex. Sheet 1.
\end{proof}
\begin{example}[Behrend's example]
    There exists a set $A \subset [N]$ containing no nontrivial 3--APs of size $\left|A \right| \ge C \exp \left(-c \sqrt{\log N}\right)N$, where $c$ and $C$ are absolute constants. This is again on Ex. Sheet 1.
\end{example}
\begin{defn}
    Let $\Gamma \subset \widehat{G}$ and $\rho>0$. By the \textbf{Bohr set}, written $B(\Gamma,\rho)$, we mean \[
    B(\Gamma,\rho) = \{x \in G \mid \left|\gamma(x)-1 \right|\le \rho ~\forall \gamma \in \Gamma\}.
    \]
    We call $\left|\Gamma \right|$ the \textbf{rank} and $\rho$ the \textbf{radius} of the Bohr set.
\end{defn}
\begin{example}
    When $G = \mathbb{F}_p^n$ and $p = 3$, we have $B(\Gamma,\rho) = \langle \Gamma \rangle^\perp ~\forall \rho<1$ (draw a picture!). For larger $p$, the same holds for smaller $\rho$.
\end{example}
\begin{lemma}
    Let $\Gamma \subset \widehat{G}$ be of size $d$ and let $\rho > 0$. Then $\left|B(\Gamma,\rho) \right| \ge \left(\frac{\rho}{2\pi}\right)^d\left|G \right|$.
\end{lemma}
\begin{proof}
    This is on Ex. Sheet 2.
\end{proof}
\begin{lemma}[Bogolyubov's lemma, again]
    Given $A \subset \mathbb{Z}_p$ of density $\alpha > 0$, $\exists \Gamma \subset \widehat{\mathbb{Z}_p}$ of size at most $2\alpha^{-2}$ such that $B\left(\Gamma,\frac{1}{2}\right) \subset A + A - A - A$.
\end{lemma}
\marginpar{31 Jan 2024, Lecture 6}
\begin{proof}
    Recall $1_A * 1_A * 1_{-A} * 1_{-A}(x) = \sum_{t \in \widehat{Z_p}}^{} \left|\widehat{1_A}(t) \right|^4 \omega^{-xt}$. Let $\Gamma = \text{Spec}_{\sqrt{\frac{\alpha}{2}}}(1_A)$ and note that for all $x \in B\left(\Gamma,\frac{1}{2}\right)$ and $t \in \Gamma$, $\cos(2\pi xt/p)>0$. Hence 
    \begin{align*}
        \text{Re}\left(\sum_{t \in \widehat{Z_p}}^{} \left|\widehat{1_A}(t) \right|^4\omega^{-xt}\right) = \underbrace{\sum_{t \in \Gamma}^{} \left|\widehat{1_A}(t) \right|^4 \cos \left(2\pi xt/p\right)}_{\ge \alpha^4} + \\
        \underbrace{\sum_{t \not\in \Gamma}^{} \left|\widehat{1_A}(t) \right|^4 \cos(2\pi xt/p)}_{\text{in absolute value }\le \sup_{t \not\in \Gamma}\left|\widehat{1_A}(t) \right|^2\sum_{}^{} \left|\widehat{1_A}(t) \right|^2 \le \left(\sqrt{\frac{\alpha}{2}}\cdot \alpha\right)^2\cdot \alpha =\frac{\alpha^4}{2}}.
    \end{align*}
\end{proof}
\section{Combinatorial methods}
For now, let $G$ be an abelian group. Given $A,B \subset G$. We defined $A+B = \{a + b \mid a \in A, b \in B\}$ and can define $A - B = \{a-b \mid a \in A, b \in B\}$. If $A$ and $B$ are finite, then $$\max(\left|A \right|,\left|B \right|)\le \left|A\pm B \right| \le \left|A \right|\left|B \right|$$
(and better bounds are available in certain settings).
\begin{example}
    Let $V\le \mathbb{F}_p^n$ be a subspace. Then $V+V=V$, so $\left|V+V \right| = \left|V \right|$. In fact, if $A \subset \mathbb{F}_p^n$ is such that $\left|A+A \right|=\left|A \right|$, then $A$ must be a coset of a subspace.
\end{example}
\begin{example}\label{example2.2}
    Let $A \subset \mathbb{F}_p^n$ be such that $\left|A+A \right|<\frac{3}{2}\left|A \right|$. Then $\exists V \le \mathbb{F}_p^n$ such that $A \subset V$ and $\left|V\right|<\frac{3}{2}\left|A\right|$. This is on Ex. Sheet 2.
\end{example}
\begin{example}\label{example2.3}
    Let $A \subset \mathbb{F}_p^n$ be a set of linearly independent vectors. Then $A+A$ has size ${\left|A\right|\choose 2}$. However, $\left|A\right|\le n$, which is a small set.
    \vspace{1mm}
     
    Let $A \subset \mathbb{F}_p^n$ be a set chosen randomly with probability $p^{-\theta n}$ with $\theta \in \left(\frac{1}{2},1\right]$. Then with high probability, $\left|A+A\right| = (1-o(1))\frac{\left|A\right|^2}{2}$.
\end{example}
\begin{defn}
    Given finite sets $A,B \subset G$, we define the \textbf{Rusza distance} $d(A,B)$ between $A$ and $B$ by $$d(A,B) = \log \frac{\left|A-B\right|}{\sqrt{\left|A\right|\left|B\right|}}.$$
\end{defn}
Observe that $d(A,B)$ is nonnegative and symmetric.
\begin{lemma}[Rusza's triangle inequality]\label{lemma2.5}
    Given finite sets $A,B,C$, we have \[
    d(A,C) \le d(A,B) + d(B,C).
    \]
\end{lemma}
\begin{proof}
    Observe that $\left|B\right|\left|A-C\right| \le \left|A-B\right|\left|B-C\right|$. Indeed, writing each $d \in A-C$ as $d = a_d-c_d$ for some $a_d \in A, c_d \in C$, the map \begin{align*}
        \phi: B \times (A-C) &\to (A-B)\times(B-C)\\
        (b,d) &\mapsto (a_d-b)\times(b-c_d)
    \end{align*}
    is injective (easy exercise). The triangle inequality now follows from the definition of the Rusza distance. 
\end{proof}
\begin{defn}
    Given a finite set $A \subset G$, we write $\sigma(A) = \frac{\left|A+A\right|}{\left|A\right|}$ for the \textbf{doubling constant} and $\delta(A)=\frac{\left|A-A\right|}{\left|A\right|}$ for the \textbf{difference constant}.
\end{defn}
Then by Lemma \ref{lemma2.5}, \[
\log \delta(A) = d(A,A) \le d(A,-A) + d(A,-A) = 2 \log \sigma(A),
\]
so $\delta(A) \le \sigma(A)^2$, i.e. $\left|A-A\right|\le \frac{\left|A+A\right|^2}{\left|A\right|}$.
\vspace{1mm}

\textbf{Notation.} Given $A \subset G$ and $l,m \in \mathbb{Z}_{\ge 0}$, write $lA-mA$ for the set \[
\underbrace{A + A + \ldots + A}_{l \text{ times}} - \underbrace{A - A - \ldots - A}_{m \text{ times}}.
\]
\begin{theorem}[Plünnecke's inequality]
    Let $A,B \subset G$ be finite sets such that $\left|A+B\right| \le K\left|A\right|$ for some $K>0$. Then for any $l,m \in \mathbb{Z}_{\ge 0}$,
    \[
    \left|lB-mB\right|\le K^{l+m}\left|A\right|.
    \]
\end{theorem}
\marginpar{02 Feb 2024, Lecture 7}
\begin{proof}
    WLOG assume that $\left|A+B\right|=K\left|A\right|$. Choose a nonempty subset $A' \subset A$ such that the ratio $\frac{\left|A'+B\right|}{\left|A'\right|}$ is minimized, and call this ratio $K'$. Then $\left|A'+B\right|=K'\left|A'\right|$, $K'\le K$ and $\left|A''+B\right|\ge K'\left|A''\right| ~\forall A'' \subset A$.
    \vspace{1mm}
     
    \textbf{Claim.} For any finite $C \subset G$, $\left|A'+B+C\right|\le K'\left|A'+C\right|$.
    \vspace{1mm}
     
    We first finish the proof assuming this claim, and then prove it. We first show that $\left|A'+mB\right|\le (K')^m\left|A\right| ~\forall m \in \mathbb{Z}_{\ge 0}$. The cases $m=0$ and $m=1$ are clear. Now suppose that $m>1$ and the result holds for $m-1$. By the claim with $C=(m-1)B$, \[
    \left|A' + mB\right| = \left|A'+B+(m-1)B\right| \le K'\left|A'+(m-1)B\right|\le K'\cdot (K')^{m-1}\left|A'\right|.
    \]
    But as in the proof of Rusza's triangle inequality, 
    \begin{align*}
        &\left|A'\right|\left|lB-mB\right| \le \left|A' + lB\right|\left|A'+mB\right| \le (K')^l \left|A'\right|(K')^m \left|A'\right|\\
        \implies & \left|lB-mB\right|\le (K')^{l+m}\left|A'\right|\le K^{l+m}\left|A\right|.
    \end{align*}
    Finally, we prove the claim by induction on $\left|C\right|$. For $\left|C\right|=1$, we are just translating sets, so the claim holds. Now suppose the claim holds for some $\left|C\right|$ and consider $C' = C \cup \{x\}$ for some $x \not\in C$. Observe 
    \begin{align*}
        A'+B+C' = (A' + B + C) \cup (A'+B+x)
    \end{align*}
    and in fact 
    \begin{align*}
        A'+B+C' = (A'+B+C) \cup (A'+B+x) \setminus (D+B+x)
    \end{align*}
    where $D = \{a \in A' \mid A'+B+x \subset A'+B+C\}$. By the definition of $K$, $\left|D+B\right|\ge K'\left|D\right|$, so 
    \begin{align*}
        \left|A'+B+C'\right| &\le \left|A'+B+C\right|+\left|(A'+B+x)\setminus (D+B+x)\right| \\
        &\le \left|A'+B+C\right| + \left|A'+B\right| - \left|D+B\right|\\
        &\le K'\left|A'+C\right| + K'\left|A'\right| - K'\left|D\right|\\
        &= K'(\left|A'+C\right|+\left|A'\right|-\left|D\right|).
    \end{align*}
    Now apply the same argument again for $A'+C' = (A' + C) \sqcup ((A'+x)\setminus (E+x))$, where $E = \{a \in A' \mid a+x \in A'+C\} \subset D$. Notice that the union is disjoint in this case. We conclude that 
    \begin{align*}
        \left|A'+C'\right| = \left|A'+C\right| + \left|A'\right| - \left|E\right| \ge \left|A'+C\right| + \left|A'\right| - \left|D\right|\\
        \implies \left|A'+B+C'\right|\le K'(\left|A'+C\right|+\left|A'\right|-\left|D\right|)\le K'\left|A'+C'\right|,
    \end{align*}
    proving the claim and hence the proof.
\end{proof}
We are now in a position to generalize Example \ref{example2.2}.
\begin{theorem}[Freiman--Rusza theorem]
    Let $A \subset \mathbb{F}_p^n$ be such that $\left|A+A\right|\le K\left|A\right|$ (i.e. $\sigma(A)=K$) for some $K>0$. Then $A$ is contained in a coset of a subspace $H\le \mathbb{F}_p^n$ of size $\left|H\right|\le K^2p^{K^4}\left|A\right|$.
\end{theorem}
\begin{proof}
    Choose maximal $X \subset 2A-A$ such that the translates $x+A$ for $x \in X$ are disjoint. $X$ cannot be too large: $\forall x \in X, x+A \subset 3A-A$ and by Plünnecke, $\left|3A-A\right| \le K^4\left|A\right|$. But the translates $x+A$ for $x \in X$ are isjoint and each of size $\left|A\right|$, so
    \[
    \left|X\right|\left|A\right| = \left|\bigcup_{x \in X}(x+A) \right|\le \left|3A-A\right| \le K^4\left|A\right|,
    \]
    hence $\left|X\right|\le K^4$. We next show that $2A-A \stackrel{(\star)}{\subset}  X+A-A$. Indeed, if $y \in 2A-A$ and $y \not\in X$, then $y+A \cap (x+A) \neq \varnothing$ for some $x \in X$ by maximality of $X$, so $y \in X+A-A$. If $y \in X$, then trivially $y \in X+A-A$. It follows by induction from $(\star)$ that for all $l\ge 2$,
    \begin{align*}
        lA-A \stackrel{(\star\star)}{\subset}  (l-1)X + A -A,
    \end{align*}
    since using the induction hypothesis,
    \begin{align*}
        lA-A &= A+(l-1)A - A \stackrel{\text{hyp}}{\subset} A + (l-2)X + A - A \\
        &= (l-2)X + 2A - A \stackrel{(\star)}{\subset } (l-2)X +X +(A-A) = (l-1)X+A-A.
    \end{align*}
    Now let $H$ be the subgroup of $\mathbb{F}_p^n$ generated by $A$, which we can write in the form $H = \cup_{l\ge 1}(lA-A) \stackrel{(\star\star)}{\subset} Y+A-A$, where $Y$ is the subgroup generated by $X$. Then $\left|Y\right|\le p^{\left|X\right|} \le p^{K^4}$, so
    \begin{align*}
        \left|H\right|\le \left|Y+A-A\right|\left|Y\right|\left|A-A\right|\le p^{K^4}K^2\left|A\right|.
    \end{align*}
\end{proof}
\marginpar{05 Feb 2024, Lecture 8}
\begin{example}
    This example shows that we need a constant that is exponential in $K$ in the previous result. Let $A = H \cup R \subset \mathbb{F}_p^n$ where $H \le \mathbb{F}_p^n$ is a subspace of dimension $K \lll d \lll n-K$, and $R$ consists of $K-1$ linearly independent vectors in $H^\perp$. Then $\left|A\right| = \left|H \cup R\right| \approx \left|H\right|$ and 
    \begin{align*}
        \left|A+A\right| = \left|(H\cup R)+(H\cup R)\right| = \left|(H+H)\cup(H+R)\cup(R+R)\right| \approx K\left|H\right| \approx K\left|A\right|
    \end{align*}
    since $H+H=H$ and $H+R$ gives us $K-1$ cosets of $H$, while $R+R$ has tiny size.
    \vspace{1mm}
     
    However, a subspace $V \le \mathbb{F}_p^n$ containing $A$ must have size $\ge p^{d+(K-1)} = \left|H\right|\cdot p^{K-1} \approx \left|A\right|\cdot p^{K-1}$,
    where the constant is exponential in $K$.
\end{example}
\begin{conj}[Polynomial Freiman--Rusza]
    Let $A \subset \mathbb{F}_p^n$ be such that $\left|A+A\right|\le K\left|A\right|$. Then there is a subspace $H \le \mathbb{F}_p^n$ of size at most $C_1(K)\left|A\right|$ such that for some $x \in \mathbb{F}_p^n$, $$\left|A \cap (x+H)\right| \ge \frac{\left|A\right|}{C_2(K)}$$ where $C_1(K)$ and $C_2(K)$ are polynomials in $K$. For $p=2$, this is now a theorem since November 2023 (by Gowers, Green, Manning, Tao).
\end{conj}
\begin{defn}
    Given an abelian group $G$ and finite sets $A,B \subset G$, define the \textbf{additive energy} between $A$ and $B$ to be \[
    E(A,B) = \frac{\#\{(a,a',b,b') \in A \times A \times B \times B \mid a+b=a'+b'\}}{\left|A\right|^{3/2}\left|B\right|^{3/2}}.
    \]
    We refer to quadruples $(a,a',b,b') \in A^2 \times B^2$ such that $a+b=a'+b'$ as \textbf{additive quadruples}.
\end{defn}
Observe that if $G$ is finite and abelian, then $$\left|A^3\right|E(A,A) = \left|G\right|^3 \mathbb{E}_{x+y=z+w}1_A(x)1_A(y)1_A(z)1_A(w) \stackrel{(\star)}{=} \left|G\right|^3 ||\widehat{1_A}||_4^4$$
where $(\star)$ follows from Ex. Sheet 1, Q3.
\begin{example}
    When $H \le \mathbb{F}_p^n$, then $E(V,V)=1$, i.e. the additive energy achieves its maximum. Exercise on Ex. Sheet 2: think of an example where the additive energy is small.
\end{example}
\begin{lemma}\label{lemma2.13}
    Let $G$ be abelian and let $A,B \subset G$ be finite. Then \[
    E(A,B) \ge \frac{\sqrt{\left|A\right|\left|B\right|}}{\left|A+B\right|}.
    \]
\end{lemma}
\begin{proof}
    Note that for some $x$ in $G$, 
    \begin{align*}
        \left|A\right|^{3/2}\left|B\right|^{3/2} E(A,B) =& \#\{(a,a',b,b') \in A \times A \times B \times B \mid a+b=a'+b'\} = x = \sum_{x \in G}^{} r_{A+B}(x)^2,
    \end{align*}
    where $r_{A+B}(x) = \# \text{ways of writing }x=a+b \text{ with }a \in A, b \in B$. Observe that 
    \begin{align*}
        \sum_{x \in G}^{} r_{A+B}(x) = \left|A\right|\left|B\right|,
    \end{align*}
    so \begin{align*}
        \left|A\right|^{3/2}\left|B\right|^{3/2}E(A,B) = \sum_{x \in G}^{} r_{A+B}(x)^2 \ge \frac{\left(\sum_{x \in G}^{} r_{A+B}(x)\right)^2}{\sum_{x \in G}^{} 1_{A+B}(x)^2} = \frac{(\left|A\right|\left|B\right|)^2}{\left|A+B\right|}
    \end{align*}
    using Cauchy--Schwarz and the fact that we're only summing over $x \in G$ that are in $A+B$.
\end{proof}
In particular, if $A \subset G$ such that $\left|A+A\right|\le K\left|A\right|$, then $E(A) \ge \frac{1}{K}$. The converse is not true.
\vspace{1mm}
 
\textbf{Remark.} The same proof goes through for $A-B$ instead of $A+B$.

\begin{example}
    Let $G$ be our favorite abelian group (really our favorite class of abelian groups, e.g. $\mathbb{Z}_p$ for $p$ running over primes). Then there exist constants $\eta,\theta>0$ such that for all sufficiently large $n$, there exists $A \subset G$ with $\left|A\right| = n$ satisfying $E(A,A) \ge \eta$ and $\left|A+A\right|\ge \theta \left|A\right|^2$. This is on Ex. Sheet 2.
\end{example}
\begin{theorem}[Balog--Szemeredi--Gowers]\label{theorem2.15}
    Let $G$ be an abelian group and let $A \subset G$ be finite such that $E(A,A) \ge \eta$ for some $\eta >0$. Then $\exists A' \subset A$ of size at least $c(\eta)\left|A\right|$ such that $$\left|A'+A'\right| \le C(\eta)\left|A\right|.$$
    Furthermore, here $c(\eta)$ and $C(\eta)$ are polynomials in $\eta$.\footnote{TODO: see beginning of lec 9 - shoudl it be $C(\eta)\left|A'\right|$ in the above?}
\end{theorem}
We first prove a technical lemma using a method called ''dependent random choice''. 
\begin{lemma}\label{lemma2.16}
    Let $A_1,A_2,\ldots,A_m \subset [n]$ and suppose $\sum_{i,j \in [m]}^{} \left|A_i \cap A_j\right|\ge \delta^2 nm^2$. Then there exists $X \subset [m]$ of size at least $\frac{\delta^5 m}{\sqrt{2}}$ such that $\left|A_i \cap A_j\right|\ge \frac{\delta^2n}{2}$ for at least $90\%$ of the pairs $(i,j) \in X^2$.
\end{lemma}
\begin{proof}
    First choose $x_1,x_2,x_3,x_4,x_5$ at random from $[n]$, and then define the set $X = \{i \in [m] \mid x_j \in A_i ~\forall j \in [5]\}$. Observe that if $\left|A_i \cap A_j\right| = \gamma n$, then $\mathbb{P}\left((i,j) \in X^2\right) = \gamma^5$, and hence (by convexity or Hölder)
    \begin{align*}
        \mathbb{E}\left|X\right|^2 = \sum_{i,j}^{} \mathbb{P}\left((i,j)\in X^2\right) \ge \delta^{10}m^2.
    \end{align*}
    Call a pair $(i,j)$ ''bad'' if $\left|A_i \cap A_j\right| < \frac{\delta^2 n}{2}$. As before,
    \begin{align*}
        \mathbb{E}(\# \text{bad pairs in }X^2) \le \frac{\delta^{10}}{2^5}m^2.
    \end{align*}
    Hence $\mathbb{E}\left(\left|X^2\right| - 16 \cdot \# \text{bad pairs in }X^2\right)=\frac{\delta^{10}}{2^5}m^2$,\footnote{TODO: This $2^5$ should just be $2$, right?} so there must be a choice of $x_1,x_2,\ldots,x_5$ such that $\left|X\right| \ge  \frac{\delta^5 m}{\sqrt{2}}$ and the proportion of bad pairs in $X$ is at most $\frac{1}{16}< 10\%$.
\end{proof}
\begin{proof}[Proof of Theorem \ref{theorem2.15}]
    \marginpar{07 Feb 2024, Lecture 9}
    We call a difference $d$ ''popular'' if $d$ can be written as $d = x-y$ with $x,y \in A$ in at least $\eta \left|A\right|/2$ ways, i.e. $r_{A-A}(d)\ge \eta\left|A\right|/2$. There must be at least $\eta \left|A\right|2$ popular differences, for if not, we get a contradiction through
    \begin{align*}
        \sum_{d}^{} r_{A-A}(d)^2 &= \sum_{d \text{ popular}}^{} r_{A-A}(d)^2 + \sum_{d \text{ not popular}}^{} r_{A-A}(d)^2 \\
        &< \eta \frac{\left|A\right|}{2}\left|A\right|^2 + \eta \frac{\left|A\right|}{2}\sum_{d }^{} r_{A-A}(d) \\
        &\le \eta \frac{\left|A\right|}{2}\left|A\right|^2 + \eta \frac{\left|A\right|}{2}\left|A\right|^2.
    \end{align*}
    Define a graph with vertex set $A$, joining $x$ and $y$ by an edge if $y-x$ is a popular difference. Then 
    \begin{align*}
        \mathbb{E}_{x \in A} \left|N(x)\right| = \frac{1}{\left|A\right|}\sum_{x \in A}^{} \left|N(x)\right| \ge \frac{\eta \left|A\right|}{2}.
    \end{align*}
    We also have $\mathbb{E}_{x, y \in A}\left|N(x) \cap N(y)\right|\ge \frac{\eta^2\left|A\right|}{4}$. Indeed, by Cauchy--Schwarz,
    \begin{align*}
        &\mathbb{E}_{x,y \in A}\left|N(x) \cap N(y)\right| = \mathbb{E}_{x,y \in A}\sum_{z \in A}^{} 1_{N(x)}(z)1_{N(y)}(z) = \sum_{z \in A}^{} \left(\mathbb{E}_{x \in A}1_{N(x)}(z)\right)^2 \\
        \ge& \frac{1}{\left|A\right|} \left(\sum_{z \in A}^{} \mathbb{E}_{x \in A}1_{N(x)}(z)\right)^2 = \frac{1}{\left|A\right|}\left(\mathbb{E}_{x \in A}\left|N(x)\right|\right)^2 \ge \frac{1}{\left|A\right|} \left(\frac{\eta \left|A\right|}{2}\right)^2 = \frac{\eta^2 \left|A\right|}{4}. 
    \end{align*}
    We apply Lemma \ref{lemma2.16} with $m=n=\left|A\right|$ and $\delta^2 = \frac{\eta^2}{4}$ to find a subset $A' \subset A$ of size $\ge \eta^{10}\frac{\left|A\right|}{2^{11}}$ with the property that $\left|N(x) \cap N(y)\right| \ge \frac{\eta^2\left|A\right|}{8}$ for at least $90\%$ of $(x,y) \in A'^2$. But then for at least $10\%$ of $x \in A'$, $\left|N(x) \cap N(y)\right| \ge \frac{\eta^2 \left|A\right|}{8}$ for at least $80\%$ of $y \in A'$. Hence $\exists  A'' \subset A'$ of size $\ge \frac{\eta^{10}\left|A\right|}{2^{15}}$ such that $\forall x \in A''$, at least $80\%$ of $z \in A'$ satisfy $\left|N(x) \cap N(z)\right|\ge \frac{\eta^2\left|A\right|}{8}$. In particular, if $x,y \in A''$, then there are at least $\frac{\eta^{10}\left|A\right|}{2^{12}}$ values of $z \in A'$ such that $\left|N(x) \cap N(z)\right|\ge \frac{\eta^2\left|A\right|}{8}$ and $\left|N(y) \cap N(z)\right|\ge \frac{eta^2\left|A\right|}{8}$.
    \vspace{1mm}
     
    [We shall prove an upper bound of $\left|A'' - A''\right|$ by showing that each element of $A''-A''$ can be written as a linear combination of distinct octuples from $A$.] 

    \vspace{1mm}
     
    For each such $z$, there are thus $\ge \left(\frac{\eta^2\left|A\right|}{8}\right)^2$ pairs $(u,v)$ such that $u \in N(x) \cap N(y)$ and $v \in N(y) \cap N(z)$. For each such pair $(u,v)$, the elements $u-x,z-u,v-z,y-v$ are all popular differences. Hence, for each pair $(u,v)$, there are at least $\left(\frac{\eta\left|A\right|}{2}\right)^4$ octuples $(a_1,a_2,\ldots,a_8) \in A^8$ such that \[
    u-x = a_2-a_1,~ z-u = a_4-a_3, ~ v-z = a_6 - a_5, ~ y-v = a_8-a_7.
    \]
    In other words, there are at least 
    \begin{align*}
        \underbrace{\left(\frac{\eta^{10}\left|A\right|}{2^{12}}\right)}_{z}\underbrace{\left(\frac{\eta^2 \left|A\right|}{8}\right)^2}_{u,v} \underbrace{\left(\frac{\eta \left|A\right|}{2}\right)^4}_{(a_1,\ldots,a_8)} = \frac{\eta^{18}}{2^{22}}\left|A\right|^7
    \end{align*}
    octuples $(a_1,\ldots,a_8) \in A^8$ such that 
    \begin{align*}
        y-x &= (u-x)  +(z-u) + (v-z) + (y-v) \\
        &= a_2-a_1 + a_4-a_3 + a_6-a_5 + a_8-a_7.
    \end{align*}
    But distinct $y-x$ give rise to distinct octuples, so 
    \begin{align*}
        &\frac{\eta^{18}}{2^{12}}\left|A\right|^7 \cdot \left|A''-A''\right| \le \left|A\right|^8 \\
        \implies& \left|A''-A''\right| \le 2^{12}\eta^{-18}\left|A\right| \le 2^{27}\eta^{-28}\left|A''\right| 
    \end{align*}
    (and $\left|A''+A''\right|$ follows from Plünnecke).
\end{proof}
\section{Probabilistic tools}
\textbf{Remark.} Assume in this chapter that all our probability spaces are finite, so we don't need to worry about convergence issues.
\begin{prop}[Khintchine's inequality]\label{prop3.1}
    Let $X_1,X_2,\ldots,X_n$ be independent random variables taking values $\pm x_i$ with probability $\frac{1}{2} ~\forall i=1,\ldots,n$. Then $\forall p \in [2,\infty)$, \[
    ||\sum_{i=1}^{n} X_i ||_{L^p(\mathbb{P})} = O \left(p^{1/2}\left(\sum_{i=1}^{n} ||X_i||_{L^2(\mathbb{P})}^2\right)^{1/2}\right)
    \]
\end{prop}
\begin{proof}
    \marginpar{09 Feb 2024, Lecture 10}
    
    By nesting of norms, it suffices to prove the case $p = 2k$ with $k \in \mathbb{N}$. For simplicity, write $X = \sum_{i=1}^{n} X_i$ and WLOG assume that $\sum_{i=1}^{n} ||X_i||_{\infty}^2 = \sum_{i=1}^{n} ||X_i||_2^2 = 1$. By Chernoff (Example \ref{ex1.3}), which states that $\forall \theta >0$, \[
    \mathbb{P}\left(\left|X\ge \theta\right|\right) \le 4 \exp(-\theta^2/4),
    \]
    we have (using integration by parts, this is the alternative something formula, rewatch lecture to find out the name)
    \begin{align*}
        ||X||_{2k}^{2k} = \int_{0}^{\infty} 2k t^{2k-1}\mathbb{P}\left(\left|X\right|\ge t\right)\mathrm{d}t \le 8k \underbrace{\int_{0}^{\infty} t^{2k-1}\exp(-t^2/4)\mathrm{d}t}_{:=I(k)}.
    \end{align*}
    We shall prove by induction that $I(k) \le C^{2k}(2k)^k/4k$ for some constant $C>0$. For $k=1$, 
    \begin{align*}
        \int_{0}^{\infty} t \exp \left(-t^2/4\right) \mathrm{d}t = [-2\exp \left(-t^2/4\right)]_0^{\infty} = 2 \le C^2\frac{2}{4} 
    \end{align*}
    for $C \ge 2$. For $k>1$, we have 
    \begin{align*}
        I(k) &= \int_{0}^{\infty}  t^{2k-2} \cdot t \exp \left(-t^2/4\right) \mathrm{d}t \\
        &= [t^{2k-2}(-2)\exp \left(-t^2/4\right)]_0^\infty - \int_{0}^{\infty} (2k-2)t^{2k-3}(-2)\exp \left(-t^2/4 \right)\mathrm{d}t \\
        &= 4(k-1)\int_{0}^{\infty} t^{2(k-1)-1} \exp(-t^2/4)\mathrm{d}t \\
        &= 4(k-1)I(k-1) \\
        &\le 4(k-1) C^{2(k-1)}\frac{(2(k-1))^{k-1}}{4(k-1)} \\
        &\le C^{2k}\frac{(2k)^k}{4k}
    \end{align*}
    for some $C$, where $C\ge \sqrt{2}$ is claimed to work.
\end{proof}
\begin{cor}[Rudin's inequality]\label{cor3.2}
    Let $\Lambda \subset \widehat{\mathbb{F}_2^n}$ be a linearly independent set and let $p \in [2,\infty)$. Then $\forall \widehat{f} \in \ell^2(\Lambda)$, i.e. $\widehat{f} : \Lambda \to \mathbb{C}$,
    \[
    ||\sum_{\gamma \in \Lambda}^{} \widehat{f}(\gamma)\gamma ||_{L^p(\mathbb{F}_2^n)} = O \left(\sqrt{p} ||\widehat{f}||_{\ell^2(\Lambda)}\right)
    \]
\end{cor}
\textbf{Remark.} Note that here the LHS uses $L^p$ for the normalized counting measure (i.e. $\mathbb{E}$), while the RHS uses $\ell^2$ for the counting measure (i.e. $\sum_{}^{} $). In other words, these are the same, except one is normalized. 
\begin{cor}[Dual form of Rudin's inequality]\label{cor3.3}
    Let $\Lambda \subset  \widehat{\mathbb{F}_2^n}$ be linearly independent and let $p \in (1,2]$. Then $\forall f \in L^p (\mathbb{F}_2^n)$, \[
    ||\widehat{f}||_{\ell^2(\Lambda)} = O \left(\sqrt{\frac{p}{p-1}} ||f||_{L^p(\mathbb{F}_2^n)}\right).
    \]
\end{cor}
\begin{proof}
    Let $f \in L^p(\mathbb{F}_2^n)$ and write $g = \sum_{\gamma \in \Lambda}^{} \widehat{f}(\gamma)\gamma$. Then, as $g$ has the same Fourier coefficients as $f$,
    \begin{align*}
        ||\widehat{f}||_{\ell^2(\Lambda)}^2 = \sum_{\gamma \in \Lambda}^{} \left|\widehat{f}(\gamma)\right|^2 = \sum_{\gamma \in \Lambda} \widehat{f}(\gamma)\overline{\widehat{g}(\gamma)} = \langle \widehat{f},\widehat{g} \rangle_{\ell^2(\mathbb{F}_2^n)} = \langle f,g \rangle_{L^2(\mathbb{F}_2^n)},
    \end{align*}
    but by Hölder, $\langle f,g \rangle_{L^2(\mathbb{F}_2^n)} \le ||f||_{L^p(\mathbb{F}_2^n)}||g||_{L^{p'}(\mathbb{F}_2^n)}$, where $\frac{1}{p} + \frac{1}{p'} = 1$. By Rudin's inequality for $p' = \frac{p}{p-1}$, we get \[
    ||g||_{L^{p'}(\mathbb{F}_2^n)} = O \left(\sqrt{p'} ||\widehat{g}||_{\ell^2(\Lambda)}\right) = O \left(\sqrt{\frac{p}{p-1}}||\widehat{f}||_{\ell^2(\Lambda)} \right),
    \]
    so 
    \begin{align*}
        &||\widehat{f}||^2_{\ell^2(\Lambda)} = ||f||_{L^p(\mathbb{F}_2^n)} O \left(\sqrt{\frac{p}{p-1}} ||\widehat{f}||_{\ell^2(\Lambda)}\right) \\
        \implies & ||\widehat{f}||_{\ell^2(\Lambda)} = O \left(\sqrt{\frac{p}{p-1}} ||f||_{L^p(\mathbb{F}_2^n)}\right).
        \qedhere
    \end{align*}
\end{proof}
Recall that given $A \subset \mathbb{F}_2^n$ of density $\alpha>0$, $\left|\text{Spec}_{\rho}(1_A)\right| \le \rho^{-2}\alpha^{-1}$. This is the best possible, as the example of a subspace $H \le \mathbb{F}_2^n$ shows $\text{Spec}_1(1_H) = H^\perp$, so $\left|\text{Spec}_1(1_H)\right| = \left|H^\perp\right| = \frac{\left|\mathbb{F}_2^n\right|}{\left|H\right|} = \left(\frac{\left|H\right|}{\left|\mathbb{F}_2^n\right|}\right)^{-1} = \alpha^{-1}$.
\begin{theorem}[Special case of Chen's theorem]\label{theorem3.4}
    LEt $A \subset \mathbb{F}_2^n$ with density $\alpha>0$. Then $\forall \rho>0$, there exists a subspace $H \le \mathbb{F}_2^n$ of dimension at most $O \left(\rho^{-2} \log \alpha^{-1}\right)$ such that $\text{Spec}_{\rho}(1_A) \subset H$.
\end{theorem}
\begin{proof}
    Let $\Lambda \subset \text{Spec}_{\rho}(1_A)$ be a maximal linearly independent subset of $\text{Spec}_{\rho}(1_A)$ and let $H = \langle \text{Spec}_\rho (1_A)\rangle$. Then $\text{dim}(H) = \left|\Lambda\right|$. By dual Rudin (Corollary \ref{cor3.3}), $\forall p \in (1,2]$,
    \begin{align*}
        (\rho \alpha)^2 \left|\Lambda\right| \le \sum_{\gamma \in \Lambda}^{} \left|\widehat{1_A}(\gamma)\right|^2 = ||\widehat{1_A}||^2_{\ell^2(\Lambda)} = O \left( \frac{p}{p-1} ||1_A||^2_{L^p(\mathbb{F}_2^n)}\right).
    \end{align*}
    We can explicitly compute 
    \begin{align*}
        ||1_A||^2_{L^p(\mathbb{F}_2^n)} = \left(\mathbb{E}_y |1_A(y)|^p \right)^{2/p} = \alpha^{2/p}.
    \end{align*}
    Thus $\left|\Lambda\right| \le \rho^{-2}\alpha^{-2} O \left(\frac{p}{p-1} \alpha^{2/p}\right)$. We want to choose $p$ very close to 1, so choose $p = 1 + \left(\log \alpha ^{-1}\right)^{-1}$ to conclude that \[
    \left|\Lambda\right|\le O \left(\rho^{-2}\log \alpha^{-1} \right)
    \]
    (calculation details omitted).
\end{proof}
\begin{theorem}[Chang's Theorem]\label{theorem3.6}
    \marginpar{12 Feb 2024, Lecture 11}
    Let $G$ be a finite abelian group and let $A \subset G$ have density $\alpha>0$. If $\Lambda \subset \text{Spec}_{\rho}(1_A)$ is dissociated, then $\left|\Lambda\right| = O \left(\rho^{-2}\log \alpha ^{-1}\right)$.
\end{theorem}

\textbf{Remark.} Last lecture, we wrote $f \in L^p(G)$ to mean that $f$ is a function on $G$ with bounded $L^p$--norm and then said $||f||_{L^p(G)} = \left(\mathbb{E}_{x \in G} f(x)^{p}\right)^{1/p}$. Since we assumed that our groups are finite, the condition ''with bounded $L^p$--norm'' is unnecessary here, but we keep it as it is in line with the usual notation. We also said that $\widehat{f} \in \ell^2(\Lambda)$ if $\widehat{f}$ is a function supported on $\Lambda \subset \widehat{G}$ with bounded $\ell^2$--norm: $||\widehat{f}||_{\ell^2(\Lambda)} = \left(\sum_{\gamma \in \Lambda}^{} \left|\widehat{f}(\gamma)\right|^2\right)^{1/2}$. Finally, $X \in L^p(\mathbb{P})$ means that the random variable $X$ has bounded $p^{\text{th}}$ moment, i.e. $\mathbb{E}\left|X\right|^p<\infty$ (with expectation taken with respect to $\mathbb{P}$).
\vspace{1mm}
 
\textbf{Remark.} The proofs of these probabilistic inequalities are nonexaminable. However, we are expected to be able to state them and apply them.  
\vspace{1mm}
 
We may boostrap Khintchine's inequality to obtain the following:
\begin{theorem}[Marcinkiewicz--Zygmund Inequality]
    Let $p \in [2,\infty)$ and let $X_1,X_2,\ldots,X_n \in L^P(\mathbb{P})$ be independent random variables with $\mathbb{E}\sum_{i=1}^{n} X_i = 0$. Then 
    \begin{align*}
        ||\sum_{i=1}^{n} X_i||_{L^P(\mathbb{P})} = O \left(p^{1/2}||\sum_{i=1}^{n} \left|X_i\right|^2||_{L^{p/2}(\mathbb{P})}^{1/2}\right).
    \end{align*}
\end{theorem}
\begin{proof}
    For $\mathbb{C}$--valued random variables, the result follows from the real caes by taking real and imaginary parts and applying the triangle inequality. 
    \vspace{1mm}
     
    Next assume that the distribution of the $X_i$'s is symmetric, i.e. $\mathbb{P}\left(X_i=a\right)=\mathbb{P}\left(X_i=-a\right) ~\forall a \in \mathbb{R}$. Partition the probability space $\Omega$ into sets $\Omega_1,\Omega_2,\ldots,\Omega_M$, writing $\mathbb{P}_j$ for the induced probability measure on $\Omega_j$, such that all $X_i$'s are symmetric and take at most two values on each $\Omega_j$. Applying Khintchine, for each $j \in [M]$, 
    \begin{align*}
        ||\sum_{i=1}^{n} X_i||_{L^p(\mathbb{P}_j)}^{p} &= O (p^{p/2} \underbrace{\left(\sum_{i=1}^{n} ||X_i||^2_{L^2(\mathbb{P}_j)}\right)^{p/2}}_{= ||\sum_{i=1}^{n} \left|X_i\right|^2 ||_{L^{p/2}(\mathbb{P}_j)}^{p/2}})
    \end{align*}
    so summing over all $j \in [M]$ and taking the $p^{\text{th}}$ roots gives the symmetric case.

    \vspace{1mm}
     
    Now suppose the $X_i$'s are arbitrary and let $Y_1,\ldots,Y_n$ be such that $X_i \sim Y_i ~\forall i$ and $X_1,\ldots,X_n,Y_1,\ldots,Y_n$ are independent. Applying the symmetric result to $X_i-Y_i$,
    \begin{align*}
        ||\sum_{i=1}^{n} (X_i-Y_i)||_{L^p(\mathbb{P} \times \mathbb{P})} &= O \left(p^{1/2} ||\sum_{i=1}^{n} \left|X_i-Y_i\right|^2||_{L^{p/2}(\mathbb{P} \times \mathbb{P})}^{1/2}\right) \\
        &= O \left(p^{1/2} ||\sum_{i=1}^{n} \left|X_i\right|^2||_{L^{p/2}(\mathbb{P})}^{1/2} \right)
    \end{align*}
    by expanding $\left|X_i-Y_i\right|^2$ and bounding above by $4\left|X_i\right|^2$. But also 
    \begin{align*}
        ||\sum_{i=1}^{n} X_i||_{L^p(\mathbb{P})} &= ||\sum_{i=1}^{n} X_i - \mathbb{E} \sum_{i=1}^{n} Y_i||_{L^p(\mathbb{P})} \\
        &\le ||\sum_{i=1}^{n} (X_i-Y_i)||_{L^p(\mathbb{P} \times \mathbb{P})}
    \end{align*}
    by convexity/Jensen.
\end{proof}
\begin{theorem}[Croot--Sisask Almost Periodicity]\label{Theorem3.8}
    Let $G$ be a finite abelian group, let $\epsilon>0$ and let $p \in [2,\infty)$. Let $A,B \subset G$ be such that $\left|A+B\right|\le K\left|A\right|$ and let $f: G \to \mathbb{C}$. Then $\exists b \in B$ and a set $X \subset B-b$ such that $$\left|X\right|\ge (2K)^{-O(\epsilon^{-2}p)} \left|B\right|$$ and 
    \begin{align*}
        ||\tau_x (f * \mu_A) - f * \mu_A||_{L^p(G)} \le \epsilon ||f||_{L^p(G)} ~\forall x \in X,
    \end{align*}
    where $\tau_x g(y) = g(y+x)$ and $\mu_A$ is the characteristic measure of $A$, defined by $\mu_A(x) = \alpha^{-1} 1_A(x)$.
\end{theorem}
\textbf{Remark.} We only need $G$ to be discrete for the result to hold, but we consider the case ''finite and abelian'' as we don't want to introduce too much notation in the proof.
\vspace{1mm}
 
\textbf{Remark.} For intuition, work through the example $f = 1_{A-A}$.

\begin{proof}
    The main idea is to approximate $f * \mu_A(y) = \mathbb{E}_{x}\mu_A(x)f(y-x) =  \mathbb{E}_{x \in A}f(y-x)$ by $\frac{1}{k}\sum_{i=1}^{k} f(y-z_i)$ with $z_i$ samped independently at random from $A$ for some suitable choice $k$. 
    \vspace{1mm}
     
    For each $y \in G$, define $Z_i(y) = \tau_{-z_i}(f)(y) - f * \mu_A(y)$ for $i \in [k]$. For fixed $y \in G$, these are independent and have mean 0, so by Marcinkiewicz--Zygmond, for each $y \in G$,
    \begin{align*}
        ||\sum_{i=1}^{k} Z_i(y)||_{L^p(\mathbb{P})}^p &= O \left(p^{p/2}||\sum_{i=1}^{k} \left|Z_i(y)\right|^2||_{L^{p/2}(\mathbb{P})}^{p/2} \right) \\
        &= O \left(p^{p/2} \mathbb{E}\left(\sum_{i=1}^{k} \left|Z_i(y)\right|^2 \right)^{p/2} \right)
    \end{align*}
    Applying Hölder with $\frac{2}{p}+\frac{1}{p'}=1$ (so $\frac{1}{p'}\cdot \frac{p}{2} = \frac{p}{2}-1$) to the expression inside the expectation gives that it is 
    \begin{align*}
        \left(\sum_{i=1}^{k} \left|Z_i(y)\right|^2\right)^{p/2} \le& \left(\sum_{i=1}^{k} 1^{p'}\right)^{\frac{1}{p'}\cdot \frac{p}{2}}\left(\sum_{i=1}^{k} \left|Z_i(y)\right|^{2\cdot \frac{p}{2}}\right)^{\frac{2}{p}\cdot \frac{p}{2}}\\
        =& k^{\frac{p}{2}-1}\sum_{i=1}^{k} \left|Z_i(y)\right|^p.
    \end{align*}
    \vspace{1mm}
     
    So for each $y \in G$, 
    \begin{align*}
        ||\sum_{i=1}^{k} Z_i(y)||_{L^p(\mathbb{P})}^p = O \left(p^{p/2} k^{\frac{p}{2}-1} \mathbb{E}\sum_{i=1}^{k} \left|Z_i(y)\right|^p\right).
    \end{align*}
    \marginpar{14 Feb 2024, Lecture 12}
    \vspace{1mm}
     
    Summing over $y \in G$ gives 
    \begin{align*}
        \mathbb{E}_{y \in G} ||\sum_{i=1}^{k} Z_i(y)||_{L^p(\mathbb{P})}^{p} = O \left(p^{p/2}k^{\frac{p}{2}-1}\mathbb{E}\sum_{i=1}^{k} \mathbb{E}_{y \in G}\left|Z_i(y)\right|^p \right)
    \end{align*}
    with 
    \begin{align*}
        \left(\mathbb{E}_{y \in G}\left|Z_i(y)\right|^p \right)^{1/p} = ||Z_i||_{L^p(G)} \le  \underbrace{||\tau_{-z_i}(f)||_{L^p(G)}}_{= ||f||_{L^p(G)}} + \underbrace{||f * \mu_A||_{L^p(G)}}_{\le ||f||_{L^p(G)}} \le 2||f||_{L^p(G)},
    \end{align*}
    where the second underbrace estimate follows by Young's Convolution Inequality, which states that if $1+\frac{1}{r}=\frac{1}{p}+\frac{1}{q}$, then $||f * g||_r \le ||f||_{p} ||g||_{q}$. It follows that
    \begin{align*}
        \mathbb{E}_{(z_1,\ldots,z_k) \in A^k}\mathbb{E}_{y \in G} |\sum_{i=1}^{k} Z_i(y)|^p &= O \left(p^{p/2}k^{p/2-1}\mathbb{E}_{(z_1,\ldots,z_k) \in A^k}\sum_{i=1}^{k} 2\cdot ||f||^p_{L^p(G)} \right) \\
        &= O \left(p^{p/2}k^{p/2}||f||_{L^p(G)}^p \right)\\
        &= O \left((pk||f||^2_{L^p(G)})^{p/2}\right),
    \end{align*}
    which implies (after dividing through by $k^{p}$) 
    \begin{align*}
        \mathbb{E}_{(z_1,\ldots,z_k) \in A^k}\underbrace{\mathbb{E}_{y \in G}\left|\frac{1}{k}\sum_{i=1}^{k} \tau_{-z_i}(f)(y) - f * \mu_A (y)\right|^p}_{:= (\star)} = O \left((pk^{-1}||f||^2_{L^p(G)})^{p/2}\right)
    \end{align*}
    Choose $k = O(\epsilon^{-2}p)$ such that RHS is at most $\left(\frac{\epsilon}{4}||f||_{L^p(G)}\right)^{p}$. Write $$L = \left\{(z_1,\ldots,z_k) \in A^k \mid (\star) \le \left(\frac{\epsilon}{2}||f||_{L^p(G)}\right)^p \right\}.$$
    By averaging/Markov, since $\mathbb{E}(\star)\le \left(\frac{\epsilon}{4}||f||_{L^p(G)}\right)^p = 2^{-p} \left(\frac{e}{2}||f||_{L^p(G)}\right)^p$, 
    \begin{align*}
        &\frac{\left|L^C\right|}{\left|A\right|^k} = \mathbb{P}\left((\star)\ge \left(\frac{\epsilon}{2}||f||_{L^p(G)}\right)^p\right) \le \mathbb{P}\left((\star)\ge 2^{p}\mathbb{E}(\star)\right) \le 2^{-p} \\
        &\implies \frac{\left|L\right|}{\left|A\right|^k}\ge 1-2^{-p}.
    \end{align*}
    So in particular, $\left|L\right|\ge \frac{1}{2}\left|A\right|^k$. Let
    \begin{align*}
        D = \{\underbrace{(b,b,\ldots,b)}_{k \text{ times}} \mid b \in B\},
    \end{align*}
    so $L + D \subset (A+B)^k$, whence (as $\left|L\right|\ge \frac{1}{2}\left|A\right|^k$) $$\left|L+D\right|\le \left|(A+B)^k\right|\le (K\left|A\right|)^k = K^k \left|A\right|^k \le (2K)^k \left|L\right|$$
    By Lemma \ref{lemma2.13}, $E(L+D,L+D) \ge \frac{\left|D\right|^2\left|L\right|}{(2K)^k}$, so there are at least $\frac{\left|D\right|^2}{(2K)^k}$ pairs $(b_1,b_2) \in D \times D$ such that $r_{L-L}(b_1-b_2) > 0$. In particular, there exists $b \in B$ and $X \subset B-b$ of size $\left|X\right|\ge \ge \frac{\left|D\right|}{(2K)^k} = \frac{\left|B\right|}{(2K)^k}$ such that $r_{L-L}(x) > 0 ~\forall x \in X$. In other words, $\forall x \in X$, $\exists l_1(x),l_2(x) \in L$ such that $\forall i \in [k]$, $l_1(x)_i = l_2(x)_i + x$. By the triangle inequality, for each $x \in X$, 
    \begin{align*}
        &||\tau_{-x}(f * \mu_A) - f * \mu_A||_{L^p(G)}\\
        \le & ||t_{-x}(f*\mu_A)-\tau_{-x}\left(\frac{1}{k}\sum_{i=1}^{k}\tau_{-l_2(x)_i}(f)\right)||_{L^p(G)} + ||\tau_{-x}\left(\frac{1}{k}\sum_{i=1}^{k}\tau_{-l_2(x)_i}(f)\right)-f* \mu_A||_{L^p(G)}\\
        =& ||f * \mu_A - \frac{1}{k}\sum_{i=1}^{k} \tau_{-l_2(x)_i}(f)||_{L^p(G)} + ||\frac{1}{k}\sum_{i=1}^{k} \tau_{-x-l_2(x)_i}(f)-f*\mu_A||_{L^p(G)}\\
        \le& 2 \cdot \frac{\epsilon}{4} ||f||_{L^p(G)}
    \end{align*}
    by the definition of $L$.
\end{proof}
\begin{theorem}[Bogolyubov again, due to Sanders]\label{theorem3.9}
    Let $A \subset \mathbb{F}_p^n$ be a set of density $\alpha>0$. Then there exists a subspace $V \le \mathbb{F}_p^n$ of codimension $O((\log(\alpha^{-1}))^4)$ such that $V \subset A+A-A-A$.
\end{theorem}
\begin{proof}
    This is on Ex. Sheet 3. Use Croot--Sisask and Chang's theorem.
\end{proof}
\begin{theorem}[due to Schoen and Shkredov]\label{theorem3.10}
    Let $p \neq 5$ and let $A \subset \mathbb{F}_p^n$. Suppose that $A$ contains no nontrivial solutions to the equation 
    \begin{align*}
        x_1 + x_2 + x_3 + x_4 + x_5 = 5y,
    \end{align*}
    i.e. no solution $(y,(x_i)_{i=1}^5) \in A^6$ such that $y \neq x_i$ for some $i \in [5]$. Then\footnote{$\Omega$ is the opposite to $O$, one lowerbounds while the other upperbounds.}
    \begin{align*}
        \left|A\right| &= \exp \left(-\Omega \left(n^{1/5}\right)\right)\left|\mathbb{F}_p^n\right| \\
        &= \exp (-\Omega_p (\log \left|\mathbb{F}_p^n\right|^{1/5}))\left|\mathbb{F}_p^n\right|.
    \end{align*}
\end{theorem}
\begin{proof}
    \marginpar{16 Feb 2024, Lecture 13}
    Let $\alpha = \frac{\left|A\right|}{\left|\mathbb{F}_p^n\right|}$ and partition $A$ into $A_1 \sqcup A_2$ with approximately equal sizes $\left|A_1\right| = \left\lfloor \frac{\alpha}{2} p^n \right\rfloor$, $\left|A_2\right| = \left\lceil \frac{\alpha}{2}p^n \right\rceil$. By averaging, $\exists z \in \mathbb{F}_p^n$ such that $\left|A_1 \cap (z-A_2)\right| \ge \frac{\alpha^2}{4}p^n$. Let $A' = A_1 \cap (z-A_2)$. By Theorem \ref{theorem3.9}, there exists a subspace $V\le \mathbb{F}_p^n$ of codimension $O(\log^4 \alpha^{-1})$ such that $V \subset A'+A'-A'-A'$ and hence $$2z + V \subset 2z + A' + A' - A' - A' \subset A_1 + A_1 + A_2 + A_2.$$ Consequently, $(5 \cdot A - A) \cap (2z + V) = \varnothing$, for if there were $x,y \in A$ with $5y-x \in 2z + V$, then we could write $5y - x = a_1 + a_1' + a_2 + a_2'$ for $a_1,a_1' \in A_1$, $a_2,a_2' \in A_2$, which (since $A_1, A_2$ are disjoint) would yield a nontrivial solution. It follows that for all $w \in \mathbb{F}_p^n$, at most one of $A \cap (w+V)$ and $5\cdot A \cap (w+2z+V)$ can be nonempty (else $a_1-a_2$ for $a_i$ in the corresponding set would lie in the above empty set). Therefore,
    \begin{align*}
        2\left|A\right| &= \sum_{w \in V^\perp}^{} \left(\left|A \cap (w + V)\right| + \left|5\cdot A \cap (w+2z + V)\right|\right) \\
        &\le \left|V^{\perp}\right| \sup_{w \in V^{\perp}} \left|A \cap (w +V)\right|.
    \end{align*} 
    Hence $\exists w \in V^\perp$ such that $\left|A \cap(w+V)\right| \ge \frac{2\left|A\right|}{\left|V^{\perp}\right|} = \frac{2\alpha \left|\mathbb{F}_p^n\right|}{\left|\mathbb{F}_p^n\right|/\left|V\right|} = 2\alpha\left|V\right|$. The set $A \cap (w +V) \subset w + V$ of density at least $2\alpha$, or equivalently $(A-w)\cap V \subset V$ of density at least $2\alpha$ contains no nontrivial solutions to $x_1+x_2+x_3+x_4+x_5=5y$. 
    
    \vspace{1mm}
     
    After $t$ iterations, we obtain a subspace $W$ of codimension $O(t \log^4 \alpha^{-1})$ and $w \in \mathbb{F}_p^n$ such that $\left|A \cap (w+V)\right| \ge 2^t \alpha \left|W\right|$. Arguing as in the proof of Meshulam's Theorem (Theorem \ref{theorem1.17}) yields the result.
\end{proof}
We have a similar bound in $\mathbb{Z}_N$, where Behrend's construction offers a comparable lower bound.

\section{Further topics}
In $\mathbb{F}_p^n$, we can do much better, even for 3-APs.
\begin{theorem}[due to Ellenberg-Gijswijt, based on Croot-Lev-Pach]\label{theorem4.1}
    Let $A \subset \mathbb{F}_3^n$ be a set containing no nontrivial 3-APs. Then \[
    \left|A\right| = o(2.765^n).
    \]
\end{theorem}
\textbf{Remark.} The proof goes through for general $p$, but we do the case $p=3$ to avoid having to constantly write $p-1$.
\vspace{1mm}
 
We first have some setup for the proof.
\begin{lemma}\label{lemma4.2}
    Let $A \subset \mathbb{F}_3^n$ and suppose $P \in V_n^d$ is such that $P(a+a') = 0 ~\forall a \neq a' \in A$. Then \[
    \left|\{a \in A \mid P(2a) \neq 0\}\right| \le 2 m_{d/2}.
    \]
\end{lemma}
\begin{proof}
    Every $P \in V_n^d$ can be written as a linear combination of monomials from $M_n^d$, so $$P(x,y) = \sum_{\substack{m,m' \in M_n^d, \\ \text{deg}(m\cdot m')\le d}}^{} c_{m,m'}m(x)m'(y)$$
    for some coefficients $c_{m,m'}$. Since at least one of $m,m'$ has to have degree at most $d/2$, we can write \[
    P(x+y) = \sum_{m \in M_n^{d/2}}^{} m(x)F_m(y) + \sum_{m' \in M_n^{d/2}}^{} m'(y) G_{m'}(x),
    \]
    where $(F_m)_{m \in M_n^{d/2}}$ and $(G_{m'})_{m' \in M_n^{d/2}}$ are polynomials. Viewing $(P(x+y))_{x,y \in A}$ as an $\left|A\right|\times\left|A\right|$-matrix $C$, we see that $C$ can be written as a sum of at most $2m_{d/2}$ matrices of rank at most 1 (as $m_x F_m(y)$ for fixed $x$ and $y$ running over $A$ gives the rows, which are all multiples of each other), hence $\text{rank}(C) \le 2m_{d/2}$.
    \vspace{1mm}
        
    But by our assumption, $C$ is a diagonal matrix whose rank equals the number of nonzero elements on the diagonal, i.e. $\left|\{a \in A \mid P(2a)=0\}\right|$.
\end{proof}
\begin{prop}\label{prop4.3}
    Let $A \subset \mathbb{F}_3^n$ be a set containing no nontrivial 3-APs. Then $\left|A\right|\le 3m_{2n/3}$.
\end{prop}
\begin{proof}
    \marginpar{19 Feb 2024, Lecture 14}
    
\end{proof}

\end{document}